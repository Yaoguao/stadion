# Настройка схемы мест для стадиона

## Обзор

Система бронирования билетов использует двухуровневую структуру:
1. **Seat (Место)** - базовое место в стадионе (venue), которое существует независимо от событий
2. **SeatInstance (Экземпляр места)** - экземпляр места для конкретного события

## Шаги настройки

### 1. Создание места проведения (Venue)

Сначала нужно создать место проведения через админ-панель или напрямую в базе данных:

```php
$venue = \App\Models\Venue::create([
    'name' => 'Стадион Лужники',
    'address' => 'ул. Лужники, 24',
    'city' => 'Москва',
    'timezone' => 'Europe/Moscow',
]);
```

### 2. Создание схемы мест

Есть два способа создать схему мест:

#### Способ 1: Через админ-панель (Рекомендуется)

1. Перейдите в **Админ панель → События**
2. Выберите событие или создайте новое
3. Нажмите **"Управление местами"**
4. Нажмите **"Создать схему мест"**
5. Заполните параметры:
   - **Количество секторов** (например, 4)
   - **Количество рядов в секторе** (например, 20)
   - **Мест в ряду** (например, 30)
   - **Базовая цена** (например, 1000 ₽)
6. Нажмите **"Создать места"**

Система автоматически:
- Создаст места с названиями секторов (A, B, C, D...)
- Рассчитает цены в зависимости от сектора и ряда (VIP зона дороже, ближе к полю - дороже)
- Назначит рейтинг обзора (1-5)

#### Способ 2: Через команду Artisan

```bash
php artisan seats:generate "Название стадиона" --sectors=4 --rows=20 --seats-per-row=30 --base-price=1000
```

Параметры команды:
- `venue` - ID или название места проведения (обязательно)
- `--sectors` - Количество секторов (по умолчанию: 4)
- `--rows` - Количество рядов в секторе (по умолчанию: 20)
- `--seats-per-row` - Количество мест в ряду (по умолчанию: 30)
- `--base-price` - Базовая цена места (по умолчанию: 1000)

Пример:
```bash
php artisan seats:generate "Лужники" --sectors=6 --rows=25 --seats-per-row=40 --base-price=1500
```

### 3. Создание экземпляров мест для события

После создания базовых мест нужно создать экземпляры мест для каждого события:

1. Перейдите в **Админ панель → События → Управление местами**
2. Нажмите **"Создать экземпляры мест для события"**

Это создаст `SeatInstance` для каждого `Seat` venue, связанного с событием.

**Примечание:** При создании нового события экземпляры мест создаются автоматически.

## Структура данных

### Seat (Место)
- `venue_id` - ID места проведения
- `sector` - Сектор (A, B, C, D...)
- `zone` - Зона (VIP, Premium, Standard)
- `row_num` - Номер ряда
- `seat_number` - Номер места в ряду
- `base_price` - Базовая цена
- `view_rating` - Рейтинг обзора (1-5)
- `is_wheelchair` - Доступно для инвалидных колясок

### SeatInstance (Экземпляр места)
- `event_id` - ID события
- `seat_id` - ID базового места
- `price` - Цена для этого события (может отличаться от base_price)
- `status` - Статус (available, reserved, sold, blocked)
- `reserved_by_booking_id` - ID бронирования, которое зарезервировало место
- `reserved_expires_at` - Время истечения резервации

## Автоматическое создание экземпляров

При создании нового события через админ-панель система автоматически:
1. Создает событие
2. Создает `SeatInstance` для всех мест venue
3. Устанавливает статус `available` для всех экземпляров

## Ручное создание экземпляров

Если нужно создать экземпляры вручную:

```php
$event = \App\Models\Event::find($eventId);
$seats = \App\Models\Seat::where('venue_id', $event->venue_id)->get();

foreach ($seats as $seat) {
    \App\Models\SeatInstance::create([
        'event_id' => $event->id,
        'seat_id' => $seat->id,
        'price' => $seat->base_price,
        'status' => \App\Models\SeatInstance::STATUS_AVAILABLE,
    ]);
}
```

## Расчет цен

Система автоматически рассчитывает цены на основе:
- **Зоны:** VIP (×1.5), Premium (×1.2), Standard (×1.0)
- **Ряда:** Ближе к полю - дороже (до +30%)

Пример:
- Базовая цена: 1000 ₽
- Сектор A (VIP), Ряд 1: ~1950 ₽
- Сектор C (Standard), Ряд 20: ~1000 ₽

## Проверка схемы

После создания схемы мест можно проверить:
1. Перейдите в **Админ панель → События → Управление местами**
2. Просмотрите статистику:
   - Всего мест
   - Экземпляров для события
   - Доступно
   - Занято
3. Просмотрите места по секторам

## Примеры конфигураций

### Малый стадион
```bash
php artisan seats:generate "Стадион" --sectors=2 --rows=10 --seats-per-row=20 --base-price=500
```
Результат: 400 мест

### Средний стадион
```bash
php artisan seats:generate "Стадион" --sectors=4 --rows=20 --seats-per-row=30 --base-price=1000
```
Результат: 2,400 мест

### Большой стадион
```bash
php artisan seats:generate "Стадион" --sectors=8 --rows=30 --seats-per-row=50 --base-price=1500
```
Результат: 12,000 мест

## Важные замечания

1. **Места создаются один раз** для venue и используются для всех событий
2. **Экземпляры мест** создаются для каждого события отдельно
3. **Цены** можно изменить вручную для конкретного события через редактирование SeatInstance
4. **Статусы мест** обновляются автоматически при бронировании:
   - `available` → `reserved` (при бронировании)
   - `reserved` → `sold` (при оплате)
   - `reserved` → `available` (при истечении времени резервации)

